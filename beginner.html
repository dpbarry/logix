<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1, interactive-widget=resizes-content">

        <link rel="stylesheet" href="style.css">

        <!-- COMPUTER MODERN SERIF -->
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/aaaakshat/cm-web-fonts@latest/fonts.css">

        <!-- SOURCE SERIF 4 -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&display=swap" rel="stylesheet">

        
        <title>Logix</title>
        <link rel="icon" type="image/png" href="images/MATHCAL_L.png">

        <style>

         /*  Prevent mismatch between viewport and body dimensions */
         html, body {
           padding: 0;
           margin: 0;
           height: 100%;
         }


         @property --myColor1 {
           syntax: '<color>';
           initial-value: rgb(110,155,250,.2);
           inherits: false;
         }

         @property --myColor2 {
           syntax: '<color>';
           initial-value: rgb(110,155,250,.5);
           inherits: false;
         }
         
         html.correct #domain {
           justify-content: right;
           transition: gap 0.5s;
           gap: 0px;

           button p {
             transition: font-size 0.1s, opacity 0.1s;
             opacity: 0;
             font-size: 0rem;
           }
           
           button:not(:first-child) {
             transition: width 1s, font-size 1s, padding 1s, border 1s, flex-basis 1s;
             width: 0px;
             box-shadow: none;
             padding: 0px;
             border: 0px;
           }
           button:first-child {

             
             flex-basis: 100%;
             width: 100%;
             border: 1px solid black;
             background: repeating-linear-gradient(20deg, var(--myColor1),  var(--myColor2) , var(--myColor1) 600px);
             background-size: calc(600px/sin(20deg)) 100%;
             animation: glow 2.5s linear infinite reverse;
             transition: --myColor1 0.25s, --myColor2 0.25s;
             
             &>.ripple {
               background: rgb(110,155,250);
               transition: all .6s;
               &.run {
                 opacity: 1 !important;
                 transform: scale(400);
               }
             }
           }
           
           button:first-child:hover {
             --myColor1: rgb(110,155,250,.5) ;
             --myColor2: rgb(110,155,250,.8);
           }

           button:first-child::before {
             content: "Next level...";
             font-family: "Source Serif 4";
             animation: spring 1s ease forwards;
             font-size: 2.5rem;
             font-weight: 325;
             font-style: italic;
             height: 100%;
             width: 100%;
             position: absolute;
             transform: translate(-50%, -50%);
             top: 50%; left: 50%;
             line-height: 3.25rem;


           }

         }


         @keyframes glow {
           0% {
             background-position: calc(600px/sin(20deg)) 0;
           }
         }

         @keyframes spring {
           0% { font-size: 0rem; }
           100% { font-size: 2.5rem; }
         }
         
         #level {
           font-family: "computer modern serif";
           font-weight: lighter;
           font-size: 2.25rem;
           
           width: min-content;
           margin: 0;

           position: relative;
           top: 1.75vmin;
           left: 2.75vmin;
           
           cursor: pointer;
         }

         #menu {
           position: absolute;
           top: 1.75vmin;
           right: 3vmin;

           /* Align #chevron */
           text-align: center; 
           
           #menu_checkbox {
             display: block;
             width: 45px;
             height: 45px;
             
             position: absolute;
             top: -6px;
             left: -6px;
             
             cursor: pointer;
             
             opacity: 0; 
             z-index: 1; 
           }
           
           #chevron {
             position: relative;
             top: 0px;
             transition: top 0.3s cubic-bezier(0.77,0.2,0.05,1.0);
           }
           
           #chevron:before {
             content: "";
             
             display: inline-block;
             height: 24px;
             width: 24px;
             
             border-bottom: 3px solid #000000;
             border-right: 3px solid #000000;
             border-radius: 0px;

             rotate: 45deg;
             transition: transform 0.3s cubic-bezier(0.77,0.2,0.05,1.0);
           }

           #menu_checkbox:checked ~ #chevron:before {
             transform: rotate(180deg);
           }
           #menu_checkbox:checked ~ #chevron {
             /* Counteract apparent upwards-shift caused by rotating chevron */
             top: 15px;
           }
           
           ul {
             width: 100%;
             margin-top: 22px;
             padding: 0;
             
             list-style-type: none;

             transform: translateY(-500%);
             will-change: transform;
             transition: transform 0.35s cubic-bezier(0.77,0.2,0.05,1.0);
           }
           
           #menu_checkbox:checked ~ ul {
             transform: none;
           }
           
           li {
             display: block;  
             height: 39px;
             width: 100%;
             margin-bottom: 14px;
             
             cursor: pointer;
             
             z-index: 1; /* Otherwise hitbox gets covered by #wrap_main spacing */

             opacity: 1;
             transition: opacity 0.2s;
           }

           @media(hover: hover) and (pointer: fine) {
             li:hover { opacity: 0.72; }
           }
           li:active {
             animation: 0.15s ease nudge forwards;
           }

           #info { content: url("images/INFO.svg"); }
           #dictionary { content: url("images/DICTIONARY.svg"); }
           #notes { content: url("images/NOTES.svg"); }
           #settings { content: url("images/SETTINGS.svg"); }
         }

         @keyframes nudge {
           0% { transform: translateY(0%); }
           50% { transform: translateY(2.25%); }
           100% {transform: translateY(0%); }
         }

         
         #wrap_main {
           display: flex;
           flex-wrap: wrap;
           justify-content: center;
         }

         #grid {
           align-self: center;
           border-spacing: 4px;

           td {
             font-family: "computer modern serif";
             border: 1px solid #000000;
             text-align: center;
             outline: 1px solid transparent; /* For crosshairs */
             border-radius: 3px;
             background-color: transparent;
             transition: background-color 0.16s ease-in, outline-color 0.2s ease;
             width: clamp(24px, 13vh, 100px);
             height: clamp(24px, 13vh, 100px);
             font-size: clamp(1rem, 7.5vh, 3rem);
             background-image: linear-gradient(#A4C1A0 , #A4C1A0);
             background-repeat: no-repeat;
             background-size: 100% 0;
             background-position: bottom;
             z-index: 1;
           }
           
           td:not(.x_axis, .y_axis) {
             cursor: pointer;
           }

           td.given {
             background-color: #D0D0D0;
           }
           td.given > .ripple, td.correct > .ripple {
             opacity: 0.4;
             background-color: #EFEFEF;
           }
           
           
           td.correct {
             background-size: 100% 100%;
             box-shadow: unset !important;
           }

           .x_axis, .y_axis {
             border: 0px;
             font-size: min(3vh, 1.7rem);
             width: min(5vh, 50px);
             height: min(5vh, 50px);
           }
           
           td:focus {
             background: #F1EEDC !important;
           }
           td.insert {
             animation: fade-in 0.15s cubic-bezier(0.25, 1, 0.5, 1) forwards;
           }
         }
         
         
         @keyframes fade-in {
           from { font-size: 0; }
           to { font-size: clamp(1rem, 7.5vh, 3rem); }
         }
         
         #propositions {
           font-size: clamp(1.5rem, 4vh, 2rem);

           cursor: default;

           display: flex;
           flex-direction: column;
           justify-content: flex-start;
           
           margin: 0;
           margin-left: 12.5vw;
           padding: 0;
           
           text-align: center;
           list-style-type: none; /* no bullet points */

           scrollbar-width: none;
           overflow-x: auto;

           -webkit-mask-image: linear-gradient(to bottom, transparent 0, black var(--top-mask-size, 0), black calc(100% - var(--bottom-mask-size, 0)), transparent 100%);
           mask-image: linear-gradient(to bottom, transparent 0, black var(--top-mask-size, 0), black calc(100% - var(--bottom-mask-size, 0)), transparent 100%);
           --top-mask-size: 0px;
           --bottom-mask-size: 0px;

           li {
             visibility: hidden;
             padding: 4px;

             width: 95%;

             &:first-child { margin-top: auto; }
             &:last-child { margin-bottom: auto; }
             
             + li {
               border-top: 1px solid #000000;
             }

             span.entry {
               padding-top: 3px;
               display: inline-block;
               border-radius: 5px;
               transition: background-color 0.3s ease, box-shadow 0.3s ease;
             }

             span.entry.highlight {
               background-color: #F1EEDC;
               box-shadow: 0 3px 1px -1px #CCCCCC, 0 0 1px 0px #CCCCCC;

             }
             
           }
           
         }

         
         #propositions.is-top-overflowing {
           --top-mask-size: 40px !important;
         }

         #propositions.is-bottom-overflowing {
           --bottom-mask-size: 40px !important;
         }
         
         #propositions::-webkit-scrollbar { 
           display: none; 
         }
         #domain::-webkit-scrollbar { 
           display: none;
         }

         #wrap_grid_domain {
           display: flex;
           flex-direction: column;
           justify-content: center;
         }

         #wrap_toolbar_domain {
           display: flex;
           flex-direction: column;
           gap: 7px;
           margin-top: -25px;
           align-items: center;
         }

         #toolbar {
           display: flex;
           width: 90vw;
           flex-basis: 100%;
           
           #pencil, #undo, #redo {
             cursor: pointer;
             background-color: transparent;
             border: 0;
             box-shadow: none;
             filter: drop-shadow(0px 1px 1px rgba(0, 0, 0, 0.35));
             border-radius: 50px;
             padding: 0;
             
           }
           #pencil {
             margin-right: auto;
             width:35px;
             height: 35px;
             transform: scale(0.9);
           }
           
           #pencil::after {
             content: "";
             background-image:url("images/PENCIL.svg");
             opacity: 0.45;
             transition: opacity 0.25s, filter 0.25s;
             background-size: 100% 100%;
             display: inline-block;
             height: 100%;
             width: 100%;
             position: relative;
             z-index: 2;
           }
           
           #undo, #redo {
             width: 32px;
             height: 32px;
           }
           
           #undo::after, #redo::after {
             content: "";
             transition: opacity 0.25s, filter 0.25s;
             opacity: 0.2;
             background-size: 100% 100%;
             display: inline-block;
             height: 100%;
             width: 24px;
             height: 24px;
             
             position: absolute;
             left: 50%;
             top: 50%;
             transform: translate(-50%, -50%);
             
             z-index: 2;
           }
           #undo::after {
             background-image:url("images/UNDO.svg");
           }
           #redo::after {
             background-image:url("images/REDO.svg");
           }
           
           @media (hover: hover) and (pointer: fine) {
             #pencil:hover, #undo:hover, #redo:hover {
               filter: drop-shadow( 0px 2px 1px rgba(0, 0, 0, .1));

             }
             #pencil:hover::after, #undo:hover::after, #redo:hover::after { 
               opacity: 1;
             }
             
           }
         }

         #domain {
           padding: 0;
           display: flex;
           align-items: flex-start;
           position: relative;
           transition: opacity 1s;

           button {
             transition: background 0.35s, box-shadow 0.25s;
             width: 100%;
             height: 56px;
             font-family: "computer modern serif";
             font-size: 2.4rem;
             background-color: #FFFFFF;
             border: 1px solid #101010;
             box-shadow: 0 3px 4px -4px #DDDDDD, 0 0 3px #EEEEEE;
             border-radius: 3px;
             cursor: pointer;
             text-align: center;
             z-index: 1;

             /* Makes sure ripple effect doesn't cover number */
             p { margin: 0;
               position: relative;
               z-index: 0; }
           }
           
           @media (hover: hover) and (pointer: fine) {
             button:hover {
               box-shadow: 0 3px 6px -6px #777, 0 0 3px #DDD;
             }   
           }
           button:focus {
             box-shadow: 0 4px 6px -6px #777, 0 0 3px #DDD;
             background-color: #F1EEDC;
             outline: none;  /* Tabbing to button adds outline by default */
           }

         }

         .ripple {
           background: #ebe7ce;
           width: 3px;
           height: 3px;
           border-radius: 100%;
           opacity: 1;
           position: absolute;
           transition: all 0.5s ease;
           pointer-events: none;
           will-change: transform;
           z-index: -1;
         }

         .ripple.run {
           transform: scale3d(180, 180, 151);
           opacity: 0 !important;
         }

         /* For ripple */
         td, #domain button {
           position: relative;
           overflow: hidden;
         }

         

         /* Landscape layout */
         @media (orientation: landscape) {
           #wrap_main {
             gap: 2.25vw;

             margin-top: 18vh;
             width: 90%;
             position: absolute;
             left: 50%;
             transform: translate(-50.1%);
           }

           @media (height < 700px) {
             #wrap_main { margin-top: calc(18vh - (700px - 100vh)/7);}
           }
           
           #propositions {
             margin: 0;
             position: relative;
             bottom: 5vh;
             display: flex;
             flex-direction: column;
             min-height: 50vh;
             max-height: 80vh;
             align-items: center;
             flex-grow: 0.5;
           }

           #wrap_toolbar_domain {
             margin-top: calc(1vh - clamp(40px, 7.5vh, 58px));
             gap: 0;
           }
           #toolbar {
             width: calc(100% - 1 * min(7vh, 50px));
             margin-left: calc(1.2 * min(5vh, 50px));
             min-height: clamp(40px, 7.5vh, 58px);
             position: relative;
             top: clamp(40px, 7.5vh, 58px);


             max-height:0;

             #pencil {
               position: absolute;
               bottom: max(min(10px, calc(10px - (750px - 100vh)/12)), -8px);
               left: -41px;
               margin: 0;
             }
             #undo {
               position: absolute;

               right: -37px;
               bottom: max(min(30px, calc(30px - (750px - 100vh)/15)), 10px);
             }
             #redo {
               position: absolute;

               right: -37px;
               bottom: max(min(-2px, calc(-2px - (750px - 100vh)/15)), -20px);
             }
           }
           #domain {
             margin-left: calc(1.2 * min(5vh, 50px));
             width: calc(100% - 1 * min(7vh, 50px));
             flex-wrap: nowrap;
             gap: 5px;
             
             
           }
         }         
         
         
         /* Portrait layout */
         @media (orientation: portrait) {
           #wrap_main {
             margin-top: 0vh;
             flex-direction: column;
             align-content: center;
             align-items: center;
           }
           #propositions {
             margin: 0;
             margin-bottom: 1.15vh;
             align-self: center;
             text-align: center;
             width: 70vw;
             height: 32.75vh; /* REDUCED WHEN <4 PROPOSITIONS */
             li {
               width: unset;
             }
           }

           #wrap_toolbar_domain {
             position: relative;
             bottom: 5px;
           }
           @media (height > 700px) {
             #wrap_grid_domain {
               gap: calc((100vh - 700px) / 13);
             }
           }
           #domain {
             width: 90vw;
             flex-direction: row;
             flex-basis: 100%;
             gap: 5px;
           }
           @media (height < 700px) {
             #grid td {
               width: clamp(24px, calc(13vh - (700px - 100vh)/14), 100px);
               height: clamp(24px, calc(13vh - (700px - 100vh)/14), 100px);
               font-size: clamp(1rem, calc(8vh - (700px - 100vh)/15), 3rem);
             }
           }
           #grid {
             margin-right: 5.09vh;
           }
         }


         .close {
           position: absolute;
           right: 20px;
           top: 18px;
           width: 30px;
           height: 30px;
           cursor: pointer;
           border-radius: 5px;
         }
         .close:hover:before, .close:hover:after {
           background-color: #000000;
         }
         .close:before, .close:after {
           border-radius: 10px;
           left: 15px;
           content: ' ';
           height: 28px;
           width: 1px;
           background-color: #444444;
           position: absolute;
         }
         .close:before {
           transform: rotate(45deg);
         }
         .close:after {
           transform: rotate(-45deg);
         }

         #overlay {
           position: fixed; 
           display: block; 
           width: 100%; 
           height: 0;
           top: 0;
           left: 0;
           right: 0;
           bottom: 0;
           z-index: 2;

           background-color: rgba(0,0,0,0.1);
           opacity: 0;
           transition: opacity .2s;
         }

         #overlay:has(~ #menu > dialog[open]) {
           height: 100%;
           opacity: 0.4;
         }
         #overlay:has(~ #menu > .hide ) {
           opacity: 0 !important;
         }

         
         dialog {
           outline: 0;
           
           position: fixed;
           margin: auto;
           display: block;
           
           font-family: "source serif 4";
           width: min(80vw, 500px);
           height: 51vh;
           visibility: hidden;
           transition: transform cubic-bezier(.25,1,.25,1) 0.25s, opacity 0.1s ;
           transform: scale(0);
           opacity: 0;
         }

         dialog::backdrop {
           opacity: 0;
         }

         dialog[open] {
           transform: scale(1);
           opacity: 1;

           visibility: visible;
           border: 1px solid #C7C7C7;
           border-radius: 10px;
           box-shadow: 0 0 8px 2px rgba(0, 0, 0, 0.15),
           0 0 30px 15px rgb(0,0,0,0.1);
         }
         dialog.hide {
           transition: transform ease-in 0.2s, opacity ease 0.2s;
           transform: scale(20%);
           perspective: 1000px;
           opacity: 0;
         }

         
         dialog {
           h1 {
             margin-top:-10px;
             margin-bottom: 20px;
             font-size: 1.95rem;
             font-weight: 600;
             text-align: center;
           }
           label {
             margin-right: 1px;
           }
           input {
             margin: 0;
             margin-bottom: 4px;
             appearance: none;
             height: 26px;
             width: 60px;
             background-color: #C0C0C0;
             position: relative;
             border-radius: 15px;
             cursor: pointer;
             transition: all 0.2s ease;
           }

           input::before {
             content: '';
             display: block;
             height: 18px;
             width: 21px;
             transform: translate(-50%, -50%);
             position: absolute;
             top: 50%;
             left: 16px;
             background-color: #3f3f3f;
             border-radius: 18px;
             transition: all 0.2s ease;
           }
           input:hover {
             filter: brightness(94%);
           }
           input:focus {
             outline: 0;
             filter: brightness(94%);
           }

           input:checked {
             background-color: #A4C1A0;
           }

           input:checked::before {
             background-color: #3e4d3c;
             left: calc(100% - 16px);
           }
           #configs {
             margin-left: 2vw;
             margin-right: 2vw;
             font-size: 1.4rem;
             font-weight: 400;
             display:flex;
             align-items: flex-end;
             justify-content: left;
             flex-wrap: wrap;
             gap: 10px;
           }
           p {
             margin: 0;
             font-style: italic;
             font-weight: 350;
             font-size: 1rem;
             flex-basis:100%;
             text-align: left;
           }

           #settings_dialog {
             max-width: 500px;
           }
         }
        </style>
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js" integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
                onload="renderMathInElement(document.body);"></script>
    </head>
    
    <body>
        <h1 id="level" onClick="">1.1</h1>
        <div id="overlay"></div>
        <div id="menu">
            <input id="menu_checkbox" type="checkbox" checked>
            <span id="chevron"></span>
            <ul>
                <li id="info" onclick="showModal('info_dialog')"></li>
                <li id="dictionary" onclick="showModal('dictionary_dialog')"></li>
                <li id="notes" onclick="showModal('notes_dialog')"></li>
                <li id="settings" onclick="showModal('settings_dialog')"></li>
            </ul>
            <dialog id="info_dialog">
                <a class="close"></a>
                <h1>INFO</h1>
            </dialog>

            <dialog id="dictionary_dialog">
                <a class="close"></a>
                <h1>DICTIONARY</h1>
            </dialog>

            <dialog id="notes_dialog">
                <a class="close"></a>
                <h1>NOTES</h1>
            </dialog>

            <dialog id="settings_dialog">
                <a class="close"></a>
                <h1>SETTINGS</h1>
                <div id="configs">
                    <label> Highlight </label>
                    <input id="highlight_toggle" type="checkbox" checked>
                    <p>Highlight appearances of selected cell in propositions</p>
                    <label> Crosshairs </label>
                    <input id="crosshairs_toggle" type="checkbox">
                    <p>Emphasize row and column of selected cell</p>
                    <label> Sticky Input </label>
                    <input id="sticky_toggle" type="checkbox" checked>
                    <p>Input selection persists after filling a cell</p>
                </div>
            </dialog>
        </div>

        <div id="wrap_main">
            <ul id="propositions">
                <li>
                    <span class="entry e1e1"> \(
                        \lang	
                        \begin{smallmatrix}
                        1 \\
                        1
                        \end{smallmatrix} \rang
                        \)
                    </span>
                    \( > \)
                    <span class="entry e1e3"> \(
                        \lang
                        \begin{smallmatrix}
                        1 \\
                        3
                        \end{smallmatrix} \rang
                        \)
                    </span>
                </li>
                <li>
                    <span class="entry e2e1">
                        \(\lang	
                        \begin{smallmatrix}
                        2 \\
                        1
                        \end{smallmatrix} \rang \)
                    </span>
                    \( = \) 
                    <span class="entry e1e1"> \(
                        \lang	
                        \begin{smallmatrix}
                        1 \\
                        1
                        \end{smallmatrix} \rang
                        \) </span>
                    \( - \)

                    <span class="entry e1e3"> \(
                        
                        \lang	
                        \begin{smallmatrix}
                        1 \\
                        3
                        \end{smallmatrix} \rang
                        \)
                    </span>
                </li>
                <li>
                    <span class="entry e2e2">
                        \(\lang	
                        \begin{smallmatrix}
                        2 \\
                        2
                        \end{smallmatrix} \rang \)</span>

                    \( \neq \)

                    <span class="entry e2e1"> \(
                        \lang	
                        \begin{smallmatrix}
                        2 \\
                        1
                        \end{smallmatrix} \rang \) </span>

                    \( \neq \)

                    <span class="entry e1e3"> \(
                        \lang	
                        \begin{smallmatrix}
                        1 \\
                        3
                        \end{smallmatrix} \rang
                        \)
                    </span>
                </li>
                <li>
                    <span class="entry e3e2">
                        \(\lang	
                        \begin{smallmatrix}
                        3 \\
                        2
                        \end{smallmatrix} \rang \) </span>

                    >

                    <span class="entry e3e3"> \(
                        \lang	
                        \begin{smallmatrix}
                        3 \\
                        3
                        \end{smallmatrix} \rang \) </span>

                    \( + \)

                    <span class="entry e2e1"> \(

                        \lang	
                        \begin{smallmatrix}
                        2 \\
                        1
                        \end{smallmatrix} \rang
                        \)
                    </span>
                </li>
                
            </ul>
            <div id="wrap_grid_domain">
                <table id="grid">            
                    <tr>
                        
                        <td class="y_axis">1</td>
                        <td></td>
                        <td class="given">2</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td class="y_axis">2</td>
                        <td></td>
                        <td></td>
                        <td class="given">3</td>
                    </tr>
                    <tr>
                        <td class="y_axis">3</td>
                        <td class="given">1</td>
                        <td></td>
                        <td></td>
                    </tr>
                    
                    <tr>
                        <td class="x_axis"></td>
                        <td class="x_axis">1</td>
                        <td class="x_axis">2</td>
                        <td class="x_axis">3</td>
                    </tr>
                </table>
                <div id="wrap_toolbar_domain">
                    <div id="toolbar">
                        <button id="pencil"> </button>

                        <button id="undo"></button>
                        <button id="redo"></button>
                    </div>
                    <div id="domain">
                        
                        <button data-value="1"><p>1</p></button>
                        <button data-value="2"><p>2</p></button>
                        <button data-value="3"><p>3</p></button>
                    </div>
                </div>
            </div>
        </div>
    </body>
    
    <script>
     const ROWS = 3;
     const COLS = 3;
     const MAXLENGTH = 1;
     const DOMAIN = [1, 2, 3]
     const SOLUTION = [[3, null, 2], [1, 3, null], [null, 3, 1]];

     var tabdCells = [[null, null, null], [null, null, null], [null, null, null]];
     var values = new Map();

     const CROSSHAIRS_TOGGLE = document.getElementById("crosshairs_toggle");
     const HIGHLIGHT_TOGGLE = document.getElementById("highlight_toggle");
     const STICKY_TOGGLE = document.getElementById("sticky_toggle");

     // fetch all inputs and cells
     const cellList = document.querySelectorAll('td:not(.x_axis, .y_axis)');
     const domainList = document.querySelectorAll('button');

     var use_highlight = HIGHLIGHT_TOGGLE.checked;
     var use_crosshairs = CROSSHAIRS_TOGGLE.checked;
     var use_sticky = STICKY_TOGGLE.checked;


     HIGHLIGHT_TOGGLE.addEventListener("change", (e) => {
       use_highlight = HIGHLIGHT_TOGGLE.checked;
     });

     CROSSHAIRS_TOGGLE.addEventListener("change", (e) => {
       use_crosshairs = CROSSHAIRS_TOGGLE.checked;
     });

     STICKY_TOGGLE.addEventListener("change", (e) => {
       use_sticky = STICKY_TOGGLE.checked;
     });

     // Show propositions when they're rendered (should be near-instant)
     document.fonts.onloadingdone = function (fontFaceSetEvent) {
       document.querySelectorAll("#propositions li").forEach((li) => {
         li.style.visibility = "visible";
       });
       verticalScroll(document.querySelector('#propositions'), 7);
       horizontalScroll(document.querySelector('#domain'));
     }

     // id cells with their coordinates
     for (let i=0, j=0; i < cellList.length; i++) {
       let row = 1+Math.floor(j/ROWS);
       let col = 1+j%COLS;
       cellList[i].id = `c${row}.${col}`;
       tabdCells[row-1][col-1] = cellList[i];
       j++;
     } 

     cellList.forEach((cell) => {
       // Set up values map
       values.set(cell, null);

       // Allow kid-gloved typing
       if (cell.classList.contains("given")) return;

       cell.tabIndex = 0;
       
       cell.addEventListener("keydown", inp);
     });

     function inp (event) {
       if (DOMAIN.includes(parseInt(event.key))) {
         event.target.innerHTML = event.key;
         event.target.classList.add("insert");
         setTimeout(function () {
           event.target.classList.remove("insert");
         }, 150);
       } else if (event.key === "Backspace") {
         event.target.innerHTML = event.target.innerHTML.substring(0, event.target.innerHTML.length-1);  
       }
       values.set(event.target, event.target.innerHTML);
       checkGrid();
     }

     function checkGrid() {
       var flag = true;

       values.forEach((value, key) => {
         var row = parseInt(key.id.charAt(1));
         var col = parseInt(key.id.charAt(3));
         
         if (value != SOLUTION[row - 1][col - 1]) {
           flag = false;
         }
       });

       if (flag) {
         // Partly for suspense
         setTimeout(success, 125); 
       }
     }
     
     function animateGridSuccess (i) {
       if (i > ROWS) return;

       var transitionStage = "";
       var delay = 0;
       
       if (i == 1) {
         transitionStage = "background-size 0.4s ease-in";
       }
       else if (i < ROWS) {
         transitionStage = "background-size .24s linear";
         delay = 399;
       }
       else if (i == ROWS) {
         transitionStage = "background-size .4s ease-out";
         delay = 239;
       }

       setTimeout(function (stage) {
         tabdCells[ROWS-i].forEach((td) => {
           td.style.transition = this;
           td.classList.add("correct");
         });
         animateGridSuccess(i+1);
       }.bind(transitionStage), delay);
     }
     
     function success() {
       crosshairs("not-a-cell");
       highlight("not-a-cell");
       
       animateGridSuccess(1);

       document.documentElement.classList.add("correct");
       cellList.forEach((cell) => {
         cell.tabIndex = -1;
         cell.onfocus = function () {this.blur();};
         cell.removeEventListener("keydown", inp);
         domainList.forEach((button) => {
           // More to come... buttons morph into next level
           button.onfocus = "";
           button.onblur = "";
         });
       });
       
       // Only blur what might be a domain button after handler is removed
       document.activeElement.blur();

     }

     for (var i = 0; i < cellList.length; i++){
       if (cellList[i].id == undefined) {
         continue;
       }
       cellList[i].onfocus = function () { crosshairs(this.id);
         highlight(this.id);  };
       cellList[i].onblur = function () { crosshairs("not-a-cell");
         highlight("not-a-cell");};
     }

     function highlight(id) {
       if (!use_highlight) return;
       document.querySelectorAll(".entry").forEach( (entry) => {

         if (entry.classList.contains(
           "e" + id.charAt(1) + "e" + id.charAt(3))) {
           entry.classList.add("highlight");
         } else {
           entry.classList.remove("highlight");
         }
       }
       );
     }

     for (let i = 0; i < domainList.length; i++) {
       domainList[i].onfocus = function () {
         // Slowdown ensures that, when switching from button A to button B, the blur handler
         // for B will wrap up before the focus handler for A fires
         setTimeout(function () {
           cellList.forEach((cell) => {
             cell.onfocus = function () {
               this.innerHTML = domainList[i].textContent;
               values.set(this, domainList[i].textContent);
               this.classList.add("insert");
               setTimeout(function () {
                 cell.classList.remove("insert");
               }, 150);
               checkGrid();
             };
           }); 
         }, 5);
       };

       domainList[i].onblur = function (e) {
         // Tiny slowdown to avoid resetting cell.onfocus before we can actually use it!
         setTimeout(function () {
           if (use_sticky && document.activeElement.parentNode.id != "domain"
               && document.activeElement != document.body) {
             e.target.focus();

           }

           cellList.forEach((cell) => {
             cell.onfocus = function () {crosshairs(this.id); highlight(this.id);};
             cell.blur();
           });
         }, 1); 
       };
     }

     
     function verticalScroll(el, moe) {
       const isScrollable = (el.scrollHeight - moe > el.clientHeight);
       
       // GUARD: If element is not scrollable, remove all classes
       if (!isScrollable) {
         el.classList.remove('is-bottom-overflowing', 'is-top-overflowing');
         return;
       }
       
       // Otherwise, the element is overflowing!
       // Now we just need to find out which direction it is overflowing to (can be both).
       // One pixel is added to the height to account for non-integer heights.
       const isScrolledToBottom = el.scrollHeight < el.clientHeight + el.scrollTop + 1;
       const isScrolledToTop = isScrolledToBottom ? false : el.scrollTop === 0;
       el.classList.toggle('is-bottom-overflowing', !isScrolledToBottom);
       el.classList.toggle('is-top-overflowing', !isScrolledToTop);
     }

     

     function horizontalScroll(el) {
       const isScrollable = (el.scrollWidth > el.clientWidth);

       // GUARD: If element is not scrollable, remove all classes
       if (!isScrollable) {
         el.classList.remove('is-left-overflowing', 'is-right-overflowing');
         return;
       }
       
       // Otherwise, the element is overflowing!
       // Now we just need to find out which direction it is overflowing to (can be both).
       // One pixel is added to the height to account for non-integer heights.
       const isScrolledToRight = el.scrollWidth < el.clientWidth + el.scrollRight + 1;
       const isScrolledToLeft = isScrolledToRight ? false : el.scrollLeft === 0;
       el.classList.toggle('is-right-overflowing', !isScrolledToRight);
       el.classList.toggle('is-left-overflowing', !isScrolledToLeft);
     }

     document.querySelector('#propositions').addEventListener('scroll', (e) => {
       const el = e.currentTarget;
       verticalScroll(el, 7);
     });

     document.querySelector('#domain').addEventListener('scroll', (e) => {
       const el = e.currentTarget;
       horizontalScroll(el);
     });

     window.onresize = function(event) {
       verticalScroll(document.querySelector('#propositions'), 7);
     }

     
     horizontalScroll(document.querySelector('#domain'));


     // given the id of a cell, emphasize borders of cells in that row and column
     function crosshairs(id) {
       if (!use_crosshairs) return;
       for (var i = 0; i < cellList.length; i++) {
         // check that the cell matches in row or column
         if (cellList[i].id.slice(1,2) == id.slice(1,2) || cellList[i].id.slice(3) == id.slice(3)) {
           cellList[i].style.outlineColor = "black";

         }
         // reset the styles of other cells without messing up the axis labels
         else if (! cellList[i].classList.contains("y_axis") && ! cellList[i].classList.contains("x_axis")) {
           cellList[i].style.outlineColor = "transparent";

         }
       }
     }

     rippleStack = [];
     function spawnRipple(mouseEvent, element) {
       rippleStack.push(element);
       document.querySelectorAll(".ripple").forEach((r) => {
         if (element === rippleStack[rippleStack.length-1])
           r.remove();
       });
       rippleStack = rippleStack.slice(rippleStack.length-1);
       if (element !== rippleStack[rippleStack.length-1])
         return;
       // Create a ripple element <div class="ripple">
       const rippleEl = document.createElement('div');
       rippleEl.classList.add('ripple');
       // Position the ripple
       const x = mouseEvent.offsetX;
       const y = mouseEvent.offsetY;
       rippleEl.style.left = `${x}px`;
       rippleEl.style.top = `${y}px`;
       element.appendChild(rippleEl);
       requestAnimationFrame(() => {
         rippleEl.classList.add('run');
       });
       // Remove ripple element when the transition is done
       rippleEl.addEventListener('transitionend', () => {
         rippleEl.remove();
       }
       );
     }

     document.querySelectorAll('td:not(.x_axis, .y_axis), #domain button').forEach(element => {
       element.addEventListener("pointerdown",  (event) => {
         spawnRipple(event, element);
         element.focus();
       });
     });
     

     function showModal(id) {
       document.getElementById(id).showModal();
     }

     const dialogList = document.querySelectorAll('dialog');

     function closeDialog (event) {
       event.target.close();
       event.target.classList.remove("hide");
       event.target.removeEventListener("transitionend", closeDialog);
     }
     
     dialogList.forEach((dialog) => {
       dialog.addEventListener('click', (e) => {
         if (e.target.tagName !== 'DIALOG')
           return;

         const rect = e.target.getBoundingClientRect();

         const clickedInDialog = (
           rect.top <= e.clientY &&
           e.clientY <= rect.top + rect.height &&
           rect.left <= e.clientX &&
           e.clientX <= rect.left + rect.width
         );

         if (clickedInDialog === false) {
           e.target.classList.add("hide");
           
           e.target.addEventListener("transitionend", closeDialog);
       }});

       dialog.addEventListener('keydown', (e) => {
         if (e.key == "Escape") {

           e.preventDefault();
           e.target.classList.add("hide");

           e.target.addEventListener("transitionend", closeDialog);
         }
       });
     });

     document.querySelectorAll(".close").forEach( (closeButton) => {
       closeButton.addEventListener("click", (e) => {
         closeButton.parentNode.classList.add("hide");
         closeButton.parentNode.addEventListener("transitionend", closeDialog);
       });
     });

     document.querySelectorAll("dialog input").forEach((toggle) => {
       toggle.addEventListener("keydown", (e) => {
         if (e.key == "Escape") {
           e.preventDefault();
           e.target.closest("dialog").classList.add("hide");
           e.target.closest("dialog").addEventListener("transitionend", closeDialog);
         }
       });
     });

     document.getElementById("level").onclick = function () {
       if (window.event.ctrlKey || window.event.shiftKey) {
         // Interestingly, Chrome will only actually focus the
         // new window if you were holding shift
         window.open("index.html", '_blank').focus();
       } else {
         location.href = "index.html";
       }
     }

     
    </script>
</html>
