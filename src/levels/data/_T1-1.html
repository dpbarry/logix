<html lang="en"><head>
        <!-- SOURCE SERIF 4 -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
        <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" rel="stylesheet">

        <!-------- KATEX -------->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
        <script defer="" src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js" integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
        <script defer="" src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
        
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Puzzle Level Generator</title>

        
        <style>
         body {
           font-family: "Source Serif 4";
           margin: 20px;

           display: flex;
           flex-direction: column;
           align-items: center;
         }
         .section {
           margin-bottom: 20px;
           width: 340px;
         }

         #general, #grid {
           label {
             font-size: 1.25rem;
             font-style: italic;
           }
           input {
             font-family: "Source Serif 4";

             position: relative;
             left: 5px;
           }
         }

         button {
           font-family: "Source Serif 4";
           background:  hsl(50, 46%, 80%);
           line-height: 35px;
           outline: 0;
           border-radius: 5px;
           border: 0;
           cursor: pointer;
         }

         

         #proplist {
           display: none;
         }

         .grid {
           display: grid;
           gap: 5px;
           margin-top: 10px;

           align-self: center;
           grid-gap: 5px;

           display: grid;
           align-items: center;
           align-content: center;
           justify-items: center;
           
           grid-template-columns: min(5vh, 30px) repeat(var(--cols), 1fr);
           grid-template-rows: repeat(var(--rows), 1fr) min(5vh, 30px);

           width: 350px;
           height: 350px;

           input {
             font-family: "computer modern serif";
             text-align: center;
             border-radius: 6px;
             outline: none;
             
             width: 100%;
             height: 100%;
             
             font-size: clamp(1rem, 9vh, 4rem);

             box-sizing: border-box;
           }

         }
         .grid-cell {
           width: 40px;
           height: 40px;
           text-align: center;
           border: 1px solid #ccc;
         }
         textarea {
           width: 100%;
           height: 100px;
         }

         input {
           max-width: 190px;
           background-color: hsl(50, 46%, 96%);
           color: #242424;
           padding: .15rem .5rem;
           min-height: 30px;
           border-radius: 4px;
           transition: border 0.3s;
           border: 1px solid lightgrey;
           outline: 0;

         }

         input:focus {
           border-radius: 4px 4px 2px 2px;
         }

         input:hover {
           border: 1px solid grey;
         }

         #proplist {
           
         }

         

         @media (orientation: landscape) {
           body {
             max-height: 100vh;
             flex-wrap: wrap;
           }
         }
        </style>
    </head>
    <body>
        <h1>Level Generator</h1>

        <div class="section" id="general">
            <h2>General Information</h2>
            <label>Level Number: <input autocomplete="off" id="levelNumber" type="text" value="1.1"></label>
            <br>
            <br>
            <label>Difficulty: <input autocomplete="off" id="difficulty" type="text" value="Training"></label>
            <br>
            <br>
            <label>Next Level: <input autocomplete="off" id="nextLevel" type="text" value="T1.2"></label>
            <br>
            <br>
            <label>Domain: <input autocomplete="off" id="domain" type="text" value="1,2,3,4"></label>

            
        </div>

        <div class="section" id="grid">
            <h2>Grid Settings</h2>
            <label>Rows: <input id="rows" autocomplete="off" type="number" min="1" value="3"></label>
            <br>
            <br>
            <label>Columns: <input id="cols" autocomplete="off" type="number" min="1" value="3"></label>
            <br>
            <br>
            <button onclick="updateGrid()">Update Grid</button>
        </div>

        <br>

        <div class="section">
            <h2>Given Values</h2>

            <div id="given" class="grid"></div>
        </div>

        <div class="section">
            <h2>Propositions</h2>
            <ul id="proplist"><li> \lang	                     \begin{smallmatrix}                     1 \\                     2                     \end{smallmatrix} \rang = 2</li><li>  \lang	                     \begin{smallmatrix}                     2 \\                     1                     \end{smallmatrix} \rang = 3</li><li> \lang	                     \begin{smallmatrix}                     2 \\                     3                     \end{smallmatrix} \rang = 1</li><li>\lang	                     \begin{smallmatrix}                     3 \\                     2                     \end{smallmatrix} \rang = 4</li></ul>
            <ul id="preview"></ul>
            <input autocomplete="off" id="proposition">
            <button onclick="updateProplist()">Update Proplist</button>
        </div>

        

        <!-- Solution Section -->
        <div class="section">
            <h2>Solution</h2>
            <div id="solution" class="grid"></div>
        </div>

        <!-- Generate Files -->
        <div class="section">
            <button onclick="generateFiles()">Generate Files</button>
            <div id="output"></div>
        </div>

        <script>
         
         function updateGrid() {
           const rows = parseInt(document.getElementById('rows').value);
           const cols = parseInt(document.getElementById('cols').value);
           const grids = document.querySelectorAll('.grid');

           grids.forEach((grid) => {
             grid.innerHTML = '';
             grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
             grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

             for (let i = 0; i < rows; i++) {
               for (let j = 0; j < cols; j++) {
                 const cell = document.createElement('input');
                 cell.type = 'text';
                 cell.autocomplete = "off";
                 cell.className = 'grid-cell';
                 
                 grid.appendChild(cell);
               }
             }
           });
         }

         function updateProplist() {
           const li = document.createElement('li');
           const proplist =  document.getElementById("proplist")
           const prop =  document.getElementById("proposition");

           li.textContent = prop.value;
           
           proplist.append(li);

           let previewLi = li.cloneNode(true);
           previewLi.textContent = `\\( ${previewLi.textContent} \\)`;
           preview.append(previewLi);
           renderMathInElement(document.getElementById("preview"));

           prop.value = "";
         }
         
         async function generateFiles() {
           const levelNumber = document.getElementById('levelNumber').value;
           const difficulty = document.getElementById('difficulty').value;
           const nextLevel = document.getElementById('nextLevel').value;
           const domain = document.getElementById('domain').value.split(',').map(Number);
           const rows = parseInt(document.getElementById('rows').value);
           const cols = parseInt(document.getElementById('cols').value);
           const propositions = document.getElementById('proplist').children;
           const given = Array.from(document.getElementById('given').children);

           const solution = Array.from(document.getElementById('solution').children).map( (x) => parseInt(x.value));
           const maxlength = document.getElementById("domain").value.split(',').reduce((longest, current) => {
             return current.length > longest.length ? current : longest;
           }, "").length;

           const parser = new DOMParser();


           let saveText = await (await fetch('codegen.html')).text();
           let save = parser.parseFromString(saveText, 'text/html');



           ["levelNumber", "difficulty", "nextLevel", "domain", "rows", "cols", "proplist", "given", "solution"].forEach( (id) => {
             
             if (save.getElementById(id).value !== undefined) {
               save.getElementById(id).defaultValue = document.getElementById(id).value;

             } else if (id === "proplist") {
               save.getElementById("proplist").append(...(Array.from(propositions).map(x => x.cloneNode(true))));
               
             } else {
               
             }
           });
           
           
           let skeletonText = await (await fetch('skeleton.html')).text();
           let page = parser.parseFromString(skeletonText, 'text/html');


           page.getElementById("level").innerHTML = levelNumber;
           page.getElementById("difficulty").innerHTML = difficulty;


           Array.from(propositions).forEach((li) => {
             let text = li.textContent;
             let varCounter = 1;

             const pattern = /\\lang\s*\\begin\{smallmatrix\}\s*([\s\S]*?)\s*\\end\{smallmatrix\}\s*\\rang/g;

             li.innerHTML = text.replace(pattern, (match, content) => {
               const [n, _, m] = content.split("\\").map(s => s.trim());

               let id;
               if (!isNaN(n) && !isNaN(m)) {
                 id = `${n}e${m}`;
               } else {
                 id = `v${varCounter++}`;
               }

               // Wrap match in KaTeX math delimiters \( ... \)
               return `<span class="entry" id="e${id}">\\( ${match} \\)</span>`;
             });

             // Wrap unwrapped content outside tags in KaTeX math delimiters \( ... \)
             li.childNodes.forEach((node) => {
               if (node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== "") {
                 node.textContent = `\\( ${node.textContent.trim()} \\)`;
               }
             });
           });





           page.getElementById("propositions").append(...propositions);


           for (let i = 1; i <= rows; i++) {
             num = document.createElement("span");
             num.innerHTML = i;
             page.getElementById("y-axis").appendChild(num);
           }

           
           for (let i = 1; i <= cols; i++) {
             num = document.createElement("span");
             num.innerHTML = i;
             page.getElementById("x-axis").appendChild(num);
           }

           given.forEach( (cell) => {
             let newCell = document.createElement("span");
             let p = document.createElement("p");
             if (cell.value) {
               p.innerHTML = cell.value;
               newCell.classList.add("given");
             }
             newCell.appendChild(p);
             page.getElementById("grid").appendChild(newCell);
           });


           domain.forEach( (n) => {
             let button = document.createElement("button");
             let p = document.createElement("p");

             p.innerHTML = n;

             button.appendChild(p);
             
             page.getElementById("domain").appendChild(button);
           });

           
           solArray = [...Array(rows)].map(e => Array(cols).fill(null));

           for (let i=0; i < solution.length; i++) {
             let row = Math.floor(i/rows);
             let col = i%cols;
             solArray[row][col] = solution[i];
           } 

           const jsContent =`ROWS = ${rows};
           COLS = ${cols};
           DOMAIN = ${JSON.stringify(domain)};
           MAXLENGTH = ${maxlength};

           SOLUTION = ${JSON.stringify(solArray)};
           NEXT_LEVEL = "${nextLevel}";
           `;

           createDownload(`${difficulty.charAt(0)}${levelNumber}.html`, page.body.innerHTML);
           createDownload(`${difficulty.charAt(0)}${levelNumber}.js`, jsContent);
           createDownload(`DATA${difficulty.charAt(0)}${levelNumber}.html`, save.documentElement.outerHTML);
         }

         function createDownload(filename, content) {
           const blob = new Blob([content], { type: 'text/plain' });
           const link = document.createElement('a');
           link.href = URL.createObjectURL(blob);
           link.download = filename;
           link.textContent = `Download ${filename}`;
           document.getElementById('output').appendChild(link);
           document.getElementById('output').appendChild(document.createElement('br'));

           
           link.click();
         }

         updateGrid();
        </script>
    

</body></html>